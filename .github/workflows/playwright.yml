name: Playwright Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'test'
        type: choice
        options: [dev, test, staging]
      browsers:
        description: 'Browsers to test'
        required: true
        default: 'chromium'
        type: choice
        options: [chromium, firefox, webkit, all]

jobs: 
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        browser: >-
          ${{
            (github.event.inputs.browsers == 'all' && fromJSON('["chromium", "firefox", "webkit"]')) ||
            (github.event.inputs.browsers && fromJSON(format('["{0}"]', github.event.inputs.browsers))) ||
            fromJSON('["chromium"]')
          }}

    steps:
      - name: ğŸ›’ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci
          npx playwright install --with-deps ${{ matrix.browser }}
      - name: ğŸ§¹ Clean previous reports
        run: |
          rm -rf playwright-report test-results

      - name: ğŸ­ Run Playwright tests
        run: |
          npx playwright test --project=${{ matrix.browser }} --reporter=html
        env:
          NODE_ENV: ${{ github.event.inputs.environment || 'test' }}

      - name: ğŸ—œï¸ Zip Playwright HTML report
        if: always()
        run: |
          test -d playwright-report || (echo "No se encontrÃ³ playwright-report" && exit 1)
          mkdir -p zipped
          zip -r "zipped/playwright-report-${{ matrix.browser }}-${{ github.run_number }}.zip" playwright-report

      - name: ğŸ“¤ Send ZIP to Discord
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -X POST \
            -F "payload_json={
              \"username\": \"Playwright Reporter ğŸ¤–\",
              \"content\": \"ğŸ§ª Playwright HTML Report - Build #${{ github.run_number }}\\nğŸ“¦ Navegador: ${{ matrix.browser }}\\nğŸ“Œ Repo: ${{ github.repository }}\\nğŸŒ¿ Branch: ${{ github.ref_name }}\"
            }" \
            -F "file1=@zipped/playwright-report-${{ matrix.browser }}-${{ github.run_number }}.zip;type=application/zip" \
            "$DISCORD_WEBHOOK_URL"

