
name: Playwright Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  #schedule:
   # - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'test'
        type: choice
        options: [dev, test, staging]
      browsers:
        description: 'Browsers to test'
        required: true
        default: 'chromium'
        type: choice
        options: [chromium, firefox, webkit, all]

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        browser: >-
          ${{
            (github.event.inputs.browsers == 'all' && fromJSON('["chromium", "firefox", "webkit"]')) ||
            (github.event.inputs.browsers && fromJSON(format('["{0}"]', github.event.inputs.browsers))) ||
            fromJSON('["chromium"]')
          }}

    steps:
    - name: üõí Checkout code
      uses: actions/checkout@v4

    - name: üîß Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: üì¶ Install dependencies
      run: |
        npm ci
        npx playwright install --with-deps ${{ matrix.browser }}

    - name: üåç Set environment variables
      run: |
        echo "PROJECT_NAME=Fichap Playwright Tests" >> $GITHUB_ENV
        echo "TEST_ENVIRONMENT=${{ github.event.inputs.environment || 'test' }}" >> $GITHUB_ENV
        echo "REPOSITORY_URL=${{ github.server_url }}/${{ github.repository }}" >> $GITHUB_ENV
        echo "BRANCH_NAME=${{ github.ref_name }}" >> $GITHUB_ENV
        echo "BUILD_NUMBER=${{ github.run_number }}" >> $GITHUB_ENV
        echo "CI_URL=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_ENV
        echo "REPORT_URL=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/reports/${{ github.run_number }}" >> $GITHUB_ENV

    - name: üé≠ Run Playwright tests
      run: npx playwright test --project=${{ matrix.browser }}
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

    - name: üìä Generate Allure Report
      if: always()
      run: |
        npx allure generate allure-results --clean -o allure-report

    - name: üì§ Upload Allure Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-report-${{ matrix.browser }}-${{ github.run_number }}
        path: allure-report/
        retention-days: 30

    - name: üìÅ Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-results-${{ matrix.browser }}-${{ github.run_number }}
        path: |
          test-results/
          playwright-report/
        retention-days: 30

    - name: üìÅ Upload HTML Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: html-report-${{ matrix.browser }}-${{ github.run_number }}
        path: playwright-report/
        retention-days: 30

  deploy-report:
    needs: test
    runs-on: ubuntu-latest
    if: always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    steps:
    - name: üõí Checkout code
      uses: actions/checkout@v4

    - name: üì• Download HTML Artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: html-report-*
        path: reports/
        merge-multiple: true

    - name: üì• Download Allure Artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: allure-report-*
        path: reports/allure
        merge-multiple: true

    - name: üìã Create index page
      run: |
        mkdir -p public/reports/${{ github.run_number }}
        cp -r reports/* public/reports/${{ github.run_number }}/
        mkdir -p public/reports/${{ github.run_number }}/allure
        cp -r reports/allure/* public/reports/${{ github.run_number }}/allure/

        cat > public/index.html << EOF
        <!DOCTYPE html>
        <html>
        <head>
            <title>Playwright Test Reports</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                .report-list { list-style-type: none; padding: 0; }
                .report-list li { margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
                .report-link { text-decoration: none; color: #0066cc; font-weight: bold; }
                .report-link:hover { text-decoration: underline; }
            </style>
        </head>
        <body>
            <h1>üé≠ Playwright Test Reports</h1>
            <ul class="report-list">
                <li>
                    <a href="reports/${{ github.run_number }}/index.html" class="report-link">üìÑ HTML Report - Build #${{ github.run_number }}</a><br>
                    <a href="reports/${{ github.run_number }}/allure/index.html" class="report-link">üìä Allure Report - Build #${{ github.run_number }}</a><br>
                    <small>Generated: $(date)</small>
                </li>
            </ul>
        </body>
        </html>
        EOF

    - name: üì£ Send report links to Discord
      if: always()
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        REPORT_URL_HTML: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/reports/${{ github.run_number }}/index.html
        REPORT_URL_ALLURE: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/reports/${{ github.run_number }}/allure/index.html
      run: |
        curl -X POST -H "Content-Type: application/json" \
        -d '{
          "username": "Playwright Reporter ü§ñ",
          "embeds": [{
            "title": "‚úÖ Test Reports for Build #${{ github.run_number }}",
            "color": 5814783,
            "fields": [
              {
                "name": "HTML Report",
                "value": "'"$REPORT_URL_HTML"'"
              },
              {
                "name": "Allure Report",
                "value": "'"$REPORT_URL_ALLURE"'"
              }
            ],
            "footer": {
              "text": "Repository: ${{ github.repository }} | Branch: ${{ github.ref_name }}"
            },
            "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"
          }]
        }' \
        $DISCORD_WEBHOOK_URL
      

    - name: üåê Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: public
        keep_files: true

